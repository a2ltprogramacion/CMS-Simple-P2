---
// @src/pages/index.astro (VERSIÓN 8.2 - Corrección Sintaxis Fusión)
import { getEntry, getCollection, type CollectionEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import { mdToHtml } from "../utils/markdown";
import ProductCard from "../components/ProductCard.astro";
import FeaturedProject from "../components/FeaturedProject.astro";
import ProjectCardV4 from "../components/ProjectCardV4.astro";

// --- Carga de Datos (V7.2) ---
const home = await getEntry("pages", "home");
const allProductos = await getCollection("productos");
const allProyectos = await getCollection("proyectos");
const allClientes = await getCollection("clientes");
const ajustes = await getEntry("ajustes", "home");

// --- Datos SEO ---
const title =
  ajustes?.data.title ?? "Innovación y Estrategia Digital";
const description =
  ajustes?.data.description ??
  "Desarrollo de productos y servicios digitales.";

// --- Datos Secciones (CORREGIDOS V8.1) ---
const hero = home?.data.hero ?? {
  show_section: true,
  title: "Innovación en <span class='text-accent'>Productos</span> y <span class'text-accent-secondary'>Servicios</span> Digitales",
  description: "Transformamos ideas complejas en soluciones tecnológicas elegantes y eficientes.",
  cta_text: "Explorar Soluciones",
  cta_url: "#soluciones"
};

// DATOS (Req #4): Sección fusionada
const nosotros = home?.data.nosotros ?? {
  show_section: true,
  title: "## Sobre Nosotros (Fallback)",
  subtitle: "Nuestra Metodología",
  description: "Descripción de nosotros por defecto.",
  lista_destacados_productos: [] // Carga los productos
};
const clientes = home?.data.clientes ?? {
  show_section: true,
  title: "Clientes (Fallback)",
  lista_destacados: [],
  show_scroller: true
};
const testimonios = home?.data.testimonios ?? {
  show_section: true,
  title: "Testimonios (Fallback)",
  lista: []
};
const proyectosSeccion = home?.data.proyectos ?? {
  show_section: true,
  title: "Lo Último (Fallback)",
  subtitle: "Así es como aplicamos nuestra metodología en casos de éxito reales.",
  lista_destacados: []
};

// --- Renderizado de Markdown ---
function render(md: string | undefined, inline = false): string {
  if (!md) return "";
  const html = mdToHtml(md);
  if (inline) {
    return html.trim().replace(/^<p>/i, "").replace(/<\/p>$/i, "");
  }
  return html;
}
const heroTitleHtml = render(hero.title, true);
const heroDescriptionHtml = render(hero.description);

// Render (Req #4)
const nosotrosTitleHtml = render(nosotros.title, true);
const nosotrosSubtitleHtml = render(nosotros.subtitle, true);
const nosotrosDescriptionHtml = render(nosotros.description);

const clientesTitleHtml = render(clientes.title, true);
const testimoniosTitleHtml = render(testimonios.title, true);
const proyectosTitleHtml = render(proyectosSeccion.title, true);
const proyectosSubtitleHtml = render(proyectosSeccion.subtitle);

// --- Lógica Testimonios ---
type Testimonio = {
  quote: string;
  author?: string;
  google_review_embed?: string;
};
const testimoniosLista: Testimonio[] = testimonios.lista ?? [];

// --- Lógica Clientes ---
const titulosClientesDestacados: string[] = clientes.lista_destacados ?? [];
const clientesParaGrid =
  titulosClientesDestacados.length > 0
    ? allClientes.filter((cliente) =>
        titulosClientesDestacados.includes(cliente.data.titulo),
      )
    : allClientes.slice(0, 12);
const TARGET_FILL_COUNT = 18;
const clientCount = allClientes.length;
let scrollerList: CollectionEntry<"clientes">[] = [];
if (clientCount > 0 && clientCount < TARGET_FILL_COUNT) {
  const repetitions = Math.ceil(TARGET_FILL_COUNT / clientCount);
  scrollerList = Array(repetitions).fill(allClientes).flat();
} else {
  scrollerList = allClientes;
}

// --- LÓGICA (Req #4): Productos Destacados (Fusión) ---
const titulosProductosDestacados: string[] = 
  nosotros.lista_destacados_productos ?? [];
const productosDestacados = 
  titulosProductosDestacados.length > 0
    ? allProductos.filter((producto) => 
        titulosProductosDestacados.includes(producto.data.title)
      )
    : allProductos.slice(0, 4);

// --- LÓGICA V7.2: "Lo Último" (Proyectos Destacados) ---
const titulosProyectosDestacados: string[] =
  proyectosSeccion.lista_destacados ??
  [];
const proyectosDestacados =
  titulosProyectosDestacados.length > 0
    ? allProyectos.filter((proyecto) =>
        titulosProyectosDestacados.includes(proyecto.data.titulo),
      )
    : allProyectos.slice(0, 4); 
const featuredProject = proyectosDestacados[0];
const otherProjects = proyectosDestacados.slice(1, 4); 
---

<Layout title={title} description={description}>
  <main>
    {/* --- SECCIÓN HERO (CONECTADA A CMS V7.5) --- */}
    {hero.show_section && (
      <section
        id="inicio"
        class="relative min-h-screen flex items-center justify-center text-center overflow-hidden bg-primary"
      >
        <div id="particles-js" class="absolute inset-0 z-0"></div>
        <div class="relative z-10 p-8 animate-fade-in-up max-w-3xl">
          <h1 
            class="text-5xl md:text-7xl font-serif font-bold mb-6 text-white"
            set:html={heroTitleHtml}
          />
          <p 
            class="text-xl md:text-2xl text-text-base/80 mb-8"
            set:html={heroDescriptionHtml}
          />
          <a
            href={hero.cta_url}
            class="bg-accent text-text-inverted font-bold py-3 px-8 text-lg hover:bg-accent-secondary inline-block hover:no-underline"
          >
            {hero.cta_text}
          </a>
        </div>
      </section>
    )}

    {/* --- SECCIÓN "NOSOTROS + PRODUCTOS" (NUEVA FUSIÓN V8.1 - Req #4) --- */}
    {
      nosotros.show_section && (
        <section id="nosotros-productos" class="py-24 px-8">
          <div class="container mx-auto max-w-screen-xl">
            {/* 1. Título de la Sección */}
            <div class="text-center mb-16 max-w-2xl mx-auto">
              <h2 
                class="text-5xl font-serif font-bold text-white mb-4"
                set:html={nosotrosTitleHtml}
              />
            </div>

            {/* 2. Contenedor Glassmorphism (Layout 2 Columnas) */}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 w-full rounded-lg overflow-hidden bg-secondary/70 backdrop-blur-md border border-white/10">
              
              {/* Columna Izquierda (Contenido) */}
              <div class="flex flex-col justify-center p-8 md:p-12 lg:p-16 border-b lg:border-b-0 lg:border-r border-white/10">
                <h3 
                  class="font-serif text-3xl md:text-4xl font-bold text-white mb-4 leading-tight"
                  set:html={nosotrosSubtitleHtml}
                />
                <div 
                  class="prose max-w-none text-text-base/80 mb-6"
                  set:html={nosotrosDescriptionHtml}
                />
                
                {/* Botón (Lista completa de Servicios/Productos) */}
                <div class="mt-auto">
                  {/* CORRECCIÓN V8.2: Sintaxis del tag <a> reparada */}
                  <a 
                    href="/productos" 
                    class="
                      bg-accent text-text-inverted font-bold 
                      py-3 px-6 text-base 
                      transition-colors duration-300 
                      hover:bg-accent-secondary inline-block hover:no-underline"
                  >
                    Ver Lista Completa de Soluciones
                  </a>
                </div>
              </div>

              {/* Columna Derecha (4 Productos Destacados) */}
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-8">
                {productosDestacados.map((producto) => (
                  <div class="relative flex flex-col h-48 w-full rounded-lg overflow-hidden group bg-primary/70 border border-white/10 transition-all hover:border-accent">
                    <img src={producto.data.image ?? '/assets/uploads/placeholder.jpeg'} alt={producto.data.title} class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-10 transition-opacity" />
                    <div class="relative z-10 flex flex-col flex-grow p-4 justify-end">
                      <h4 class="text-lg font-serif font-bold text-white mb-1">{producto.data.title}</h4>
                      <p class="text-sm text-text-base/70">{producto.data.subtitle}</p>
                    </div>
                  </div>
                ))}
              </div>

            </div>
          </div>
        </section>
      )
    }

    {/* --- SECCIÓN "LO ÚLTIMO" (Sin cambios V7.5) --- */}
    {
      proyectosSeccion.show_section && featuredProject && (
        <section id="lo-ultimo" class="py-24 px-4 md:px-8">
          <div class="container mx-auto max-w-screen-xl">
            <div class="text-center mb-16 max-w-2xl mx-auto">
              <h2 class="text-5xl font-serif font-bold text-white mb-4">
                <span set:html={proyectosTitleHtml} />
              </h2>
              <p 
                class="text-lg text-text-base/80"
                set:html={proyectosSubtitleHtml}
              />
            </div>
            <div class="max-w-6xl mx-auto mb-12">
              <FeaturedProject project={featuredProject} />
            </div>
            {otherProjects.length > 0 && (
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {otherProjects.map((project) => (
                  <ProjectCardV4 project={project} />
                ))}
              </div>
            )}
          </div>
        </section>
      )
    }

    {/* --- SECCIÓN "CLIENTES" (Header V7.5) --- */}
    {
      clientes.show_section && (
        <section id="clientes" class="pt-20">
          <div class="text-center mb-16 max-w-2xl mx-auto px-8">
            <h2 class="text-5xl font-serif font-bold text-white mb-4">
              <span set:html={clientesTitleHtml} />
            </h2>
          </div>
          <div class="bg-primary py-20">
            <div class="w-full max-w-screen-2xl mx-auto px-8">
              <div class="flex flex-wrap justify-center gap-x-4 gap-y-4 max-w-7xl mx-auto">
                {clientesParaGrid.map((cliente) =>
                  cliente.data.url ?
(
                    <a
                      href={cliente.data.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block text-center opacity-70 transition-opacity duration-300 hover:opacity-100"
                      title={cliente.data.titulo}
                    >
                      <img
                        src={cliente.data.logo}
                        alt={cliente.data.titulo}
                        class="h-72 w-auto object-contain mx-auto"
                      />
                    </a>
                   ) : (
                    <div
                      class="text-center opacity-70"
                      title={cliente.data.titulo}
                    >
                      <img
                        src={cliente.data.logo}
                        alt={cliente.data.titulo}
                        class="h-72 w-auto object-contain mx-auto"
                      />
                    </div>
                  ),
                )}
              </div>
            </div>
           </div>
          {clientes.show_scroller && scrollerList.length > 0 && (
            <div class="bg-secondary/70 backdrop-blur-md py-12 marquee-viewport">
              <div class="marquee-track">
                <div class="marquee-list">
                  {scrollerList.map((cliente) => (
                     <img
                      src={cliente.data.logo}
                      alt={cliente.data.titulo}
                      title={cliente.data.titulo}
                      class="h-32 w-auto object-contain"
                    />
                  ))}
                </div>
                <div class="marquee-list" aria-hidden="true">
                  {scrollerList.map((cliente) => (
                     <img
                      src={cliente.data.logo}
                      alt={cliente.data.titulo}
                      title={cliente.data.titulo}
                      class="h-32 w-auto object-contain"
                    />
                  ))}
                </div>
              </div>
            </div>
          )}
         </section>
      )
    }

    {/* --- SECCIÓN "TESTIMONIOS" (Header V7.5) --- */}
    {
      testimonios.show_section && (
        <section id="testimonios" class="py-20 px-8">
          <div class="w-full max-w-screen-2xl mx-auto text-center">
            <div class="text-center mb-16 max-w-2xl mx-auto">
              <h2 class="text-5xl font-serif font-bold text-white mb-4">
                <span set:html={testimoniosTitleHtml} />
              </h2>
            </div>
            {testimoniosLista.length > 0 ?
(
              <div class="relative max-w-4xl mx-auto">
                <div class="overflow-hidden" id="clientes-viewport">
                  <div
                    class="flex transition-transform duration-700 ease-in-out"
                    id="clientes-track"
                    style="transform: translateX(0%);"
                  >
                    {testimoniosLista.map((cliente: Testimonio) => (
                      <div class="min-w-full p-6 flex-shrink-0 flex items-center justify-center">
                        <div class="w-full max-w-3xl bg-secondary/70 backdrop-blur-md p-8 shadow-md text-left clientes-card border-l-4 border-accent-secondary">
                          {cliente.google_review_embed ? (
                            <div set:html={cliente.google_review_embed} />
                           ) : (
                            <>
                              <p class="text-lg md:text-xl italic mb-4 quote whitespace-normal break-words text-text-base">
                                <span set:html={mdToHtml(cliente.quote)} />
                              </p>
                              <p class="font-bold text-right mt-4 author text-white">
                                - {cliente.author}
                              </p>
                            </>
                          )}
                         </div>
                      </div>
                    ))}
                  </div>
                </div>
                 <button
                  aria-label="Anterior"
                  id="clientes-prev"
                  class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/30 text-white rounded-full w-10 h-10 flex items-center justify-center backdrop-blur-sm"
                >
                   ‹
                </button>
                <button
                  aria-label="Siguiente"
                  id="clientes-next"
                  class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/30 text-white rounded-full w-10 
 h-10 flex items-center justify-center backdrop-blur-sm"
                >
                  ›
                </button>
                <div
                  id="clientes-dots"
                  class="flex justify-center gap-3 mt-6"
                />
              </div>
            ) : (
              <p class="text-text-base/70">
                (Los testimonios de los clientes se mostrarán aquí...)
               </p>
            )}
          </div>
        </section>
      )
    }
  </main>
</Layout>

{/* Estilos y Scripts (Sin cambios respecto a V7.4) */}
<style>
  /* Animación fade-in-up */
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in-up {
    animation: fade-in-up 1s ease-out forwards;
  }

  /* Estilos del Carrusel (Testimonios) - Adaptado V7.0 */
  #clientes-dots button {
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    background: #E0E0E066; /* theme("colors.text-base / 0.4") */
    border: none;
  }
  #clientes-dots button.active {
    background: #E0E0E0;
 /* theme("colors.text-base") */
  }

  .clientes-card {
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .clientes-card .quote {
    line-height: 1.5;
    max-height: 28vh;
    overflow: auto;
  }
  .clientes-card .author {
    margin-top: 1rem;
  }
  .clientes-card,
  .clientes-card .quote {
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  @media (min-width: 768px) {
    .clientes-card {
      min-height: 200px;
    }
  }

  /* --- Estilos del Scroller Infinito (Marquesina) --- */
  @keyframes marquee-scroll {
    0% {
      transform: translateX(0%);
    }
    100% {
      transform: translateX(-50%);
    }
  }
  .marquee-viewport {
    overflow: hidden;
    width: 100%;
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }
  .marquee-track {
    display: flex;
    width: fit-content;
    animation: marquee-scroll 60s linear infinite;
  }
  .marquee-track:hover {
    animation-play-state: paused;
  }
  .marquee-list {
    display: flex;
    align-items: center;
    gap: 4rem; 
    padding: 0 2rem;
    flex-shrink: 0;
  }
  .marquee-list img {
    flex-shrink: 0;
  }
  
  /* Contenedor de Partículas */
  #particles-js {
    width: 100%;
    height: 100%;
  }
</style>

<script>
  // --- Script del carrusel de testimonios (CORREGIDO V7.3) ---
  document.addEventListener("DOMContentLoaded", () => {
    (function () {
      const track = document.getElementById("clientes-track");
      const prev = document.getElementById("clientes-prev");
      const next = document.getElementById("clientes-next");
      const dotsContainer = document.getElementById("clientes-dots");
      const viewport = document.getElementById("clientes-viewport");

      if (!track || !dotsContainer) return;
      const slides = Array.from(track.children);
      const total = slides.length;
       if (total === 0) return;

      let index = 0;
      // CAMBIO V7.3: Se añade el tipo 'number | null' para 'timer'
      let timer: number | null = null;
      const interval = 10000;

      // CAMBIO V7.3: Se añade el tipo 'number' para 'i'
      function goTo(i: number) {
        index = (i + total) % total;
        if (track)
           (track as HTMLElement).style.transform =
            `translateX(-${index * 100}%)`;
        if (dotsContainer)
          Array.from(dotsContainer.children).forEach((b, idx) =>
            (b as HTMLElement).classList.toggle("active", idx === index),
          );
      }

      function nextSlide() { goTo(index + 1);
 }
      function prevSlide() { goTo(index - 1);
 }

      for (let i = 0; i < total; i++) {
        const b = document.createElement("button");
        b.type = "button";
        b.addEventListener("click", () => {
          goTo(i);
          resetTimer();
        });
        dotsContainer.appendChild(b);
      }

      if (next)
        next.addEventListener("click", () => {
          nextSlide();
          resetTimer();
        });
      if (prev)
        prev.addEventListener("click", () => {
          prevSlide();
          resetTimer();
        });
      function startTimer() {
        if (timer) clearInterval(timer);
        timer = window.setInterval(nextSlide, interval);
      }
      function stopTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }
      function resetTimer() {
        stopTimer();
        startTimer();
      }

      [viewport, track, prev, next, dotsContainer].forEach((el) => {
        if (!el) return;
        el.addEventListener("mouseenter", stopTimer);
        el.addEventListener("mouseleave", startTimer);
        el.addEventListener("focusin", stopTimer);
        el.addEventListener("focusout", startTimer);
      });
      goTo(0);
      startTimer();
    })();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    tsParticles.load("particles-js", {
      "fullScreen": {
        "enable": false 
      },
      "particles": {
        "number": {
          "value": 80, 
          "density": {
            "enable": true,
            "value_area": 800
          }
        },
        "color": {
          "value": "#00BFFF" // 'accent'
        },
        "shape": {
          "type": "circle"
        },
        "opacity": {
          "value": 0.5
        },
        "size": {
          "value": 3,
          "random": true
        },
        "line_linked": {
          "enable": true,
          "distance": 150,
          "color": "#D900FF", // 'accent-secondary'
           "opacity": 0.4,
          "width": 1
        },
        "move": {
          "enable": true,
          "speed": 2, 
          "direction": "none",
          "out_mode": "out"
        }
      },
      "interactivity": {
         "detect_on": "canvas",
        "events": {
          "onhover": {
            "enable": true,
            "mode": "grab" 
          },
          "onclick": {
            "enable": true,
            "mode": "push" 
          },
          "resize": true
        },
        "modes": {
          "grab": {
            "distance": 140,
            "line_opacity": 1
          },
          "push": {
             "particles_nb": 4
          }
        }
      },
      "retina_detect": true
    });
  });
</script>